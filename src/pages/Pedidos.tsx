import Head from 'next/head'
import { initializeApp } from 'firebase/app';
import { collection, getDocs, getFirestore, query, where, orderBy, Timestamp } from 'firebase/firestore/lite';
import { useEffect, useState } from 'react';
import { getAuth, signOut } from 'firebase/auth';
import { useRouter } from 'next/router'
import ListOldOrders from '@/containers/ListOldOrders';
import NewOrder from '@/containers/NewOrder';
import { MenuItem } from '@/types/MenuItem';

type PedidosProps = {
  firebaseConfig: {
    apiKey: string
    authDomain: string
    databaseURL: string
    projectId: string
    storageBucket: string
    messagingSenderId: string
    appId: string
  }
}
export default function Pedidos({ firebaseConfig }: PedidosProps) {
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const router = useRouter();
  const [menu, setMenu] = useState<MenuItem[]>([]);

  const [oldOrders, setOldOrders] = useState<any[]>([]);

  async function getMenu() {
    const menuColection = query(collection(db, 'menu'))
    const menuSnapshot = await getDocs(menuColection);
    const menuList = menuSnapshot.docs.map(doc => {
      return { id: doc.id, ...doc.data() }
    }) as MenuItem[];

    setMenu(menuList);
  }

  async function getOrders() {
    const today = new Date();
    const startDate = Timestamp.fromDate(
      new Date(today.getFullYear(), today.getMonth(), today.getDate())
    );

    const orderColection = query(
      collection(db, 'order'),
      where('created_at', '>', startDate),
      orderBy('created_at', 'desc'));

    const orderSnapshot = await getDocs(orderColection);
    const orderList = orderSnapshot.docs.map(doc => {
      return { id: doc.id, ...doc.data() }
    });
    setOldOrders(orderList);
  }

  const logoutUser = async () => {
    const auth = getAuth();
    try {
      await signOut(auth);
      router.push('/')
    } catch (error) {
      console.log(error)
    }
  }

  useEffect(() => {
    getMenu();
    getOrders()
  }, [])

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <button onClick={logoutUser}>Sair</button>

        <br />

        <NewOrder
          menu={menu}
          db={db}
        />

        <br />

        <ListOldOrders
          oldOrders={oldOrders}
          menu={menu}
        />
      </main>
    </>
  )
}


export async function getStaticProps() {
  const firebaseConfig = {
    apiKey: process.env.APIKEY,
    authDomain: process.env.AUTHDOMAIN,
    databaseURL: process.env.DATABASEURL,
    projectId: process.env.PROJECTID,
    storageBucket: process.env.STORAGEBUCKET,
    messagingSenderId: process.env.MESSAGINGSENDERID,
    appId: process.env.APPID,
  };

  return {
    props: {
      firebaseConfig
    },
  }
}